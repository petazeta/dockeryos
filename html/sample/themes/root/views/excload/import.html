<!--
thisNode: dashboard expimp
-->
<div class="dashboard">
  <div style="text-align:center" class="export-import">
    <form style="display:flex; flex-flow:column;align-items:center;">
      <div class="space"></div>
      <div class="msgbox" style="position:relative;">
        <div data-id="butedit" class="btmiddleright"></div>
        <span></span>
        <script>
          const title=thisNode.getNextChild("titimp").getRelationship("domelementsdata").getChild();
          title.writeProperty(thisElement);
          //adding the edition pencil
          if (webuser.isWebAdmin()) {
            const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
            visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
            title.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
          }
         </script>
      </div>
      <div style="padding-top: 10px">
        <textarea name="impdata" rows="10" cols="50"></textarea>
      </div>
      <div>
        <div class="msgbox">
          <table style="margin:auto; text-align:left; margin-bottom:1em;">
            <tr>
              <td>
                <span style="position:relative;">
                  <input type="radio" value="general" name="dataoption">
                  <div data-id="butedit" class="btmiddleright"></div>
                  <span></span>
                  <script>
                    const title=thisNode.getNextChild("chkgeneral").getRelationship("domelementsdata").getChild();
                    title.writeProperty(thisElement);
                    //adding the edition pencil
                    if (webuser.isWebAdmin()) {
                      const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
                      visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
                      title.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
                    }
                  </script>
                </span>
              </td>
            </tr>
            <tr>
              <td>
                <span style="position:relative;">
                  <input type="radio" value="catalog" name="dataoption">
                  <div data-id="butedit" class="btmiddleright"></div>
                  <span></span>
                  <script>
                    const title=thisNode.getNextChild("chkcatg").getRelationship("domelementsdata").getChild();
                    title.writeProperty(thisElement);
                    //adding the edition pencil
                    if (webuser.isWebAdmin()) {
                      const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
                      visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
                      title.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
                    }
                  </script>
                </span>
              </td>
            </tr>
            <tr>
              <td>
                <span style="position:relative;">
                  <input type="radio" value="checkout" name="dataoption">
                  <div data-id="butedit" class="btmiddleright"></div>
                  <span></span>
                  <script>
                    const title=thisNode.getNextChild("chkcheckout").getRelationship("domelementsdata").getChild();
                    title.writeProperty(thisElement);
                    //adding the edition pencil
                    if (webuser.isWebAdmin()) {
                      const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
                      visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
                      title.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
                    }
                  </script>
                </span>
              </td>
            </tr>
            <tr>
              <td>
                <span style="position:relative;">
                  <input type="radio" value="lang" name="dataoption">
                  <script>
                    const {AlertMessage}=await import('./' + CLIENT_MODULES_PATH + 'alert.js');
                    const {NodeFemale}=await import('./' + CLIENT_MODULES_PATH + 'nodesfront.js');
                    thisElement.form.dataoption.forEach(radio=>{
                      radio.addEventListener("change", (ev)=>{
                      if (thisElement.checked) {
                        if (!thisElement.form.impdata.value) {
                          (new AlertMessage(thisElement.form.elements.nocontent.value, 2000)).showAlert();
                          thisElement.checked=false;
                          return false;
                        }
                        let data=JSON.parse(thisElement.form.impdata.value);
                        let datalang=new NodeFemale();
                        datalang.load(data.languages);
                        datalang.setChildrenView(thisElement.parentElement.querySelector("template").nextElementSibling, thisElement.parentElement.querySelector("template"));
                        thisElement.parentElement.querySelector("template").nextElementSibling.style.display="block";
                      }
                      else thisElement.parentElement.querySelector("template").nextElementSibling.style.display="none";
                      });
                    });
                  </script>
                  <div data-id="butedit" class="btmiddleright"></div>
                  <span></span>
                  <script>
                    const title=thisNode.getNextChild("chklang").getRelationship("domelementsdata").getChild();
                    title.writeProperty(thisElement);
                    
                    //adding the edition pencil
                    if (webuser.isWebAdmin()) {
                      const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
                      visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
                      title.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
                    }
                  </script>
                  <template>
                    <div style="margin:auto; text-align:left; margin-bottom:0.2em">
                      <input type="checkbox" value="" name="">
                      <script>
                        thisNode.writeProperty(thisElement, "id", "value");
                        thisNode.writeProperty(thisElement, "code", "name");
                      </script>
                      <span></span>
                      <script>
                        thisNode.writeProperty(thisElement, "code");
                      </script>
                    </div>
                  </template>
                  <div class="msgbox" style="display:none"></div>
                </span>
              </td>
            </tr>
            <tr>
              <td>
                <span style="position:relative;">
                  <input type="radio" value="users" name="dataoption">
                  <div data-id="butedit" class="btmiddleright"></div>
                  <span></span>
                  <script>
                    const title=thisNode.getNextChild("chkusers").getRelationship("domelementsdata").getChild();
                    title.writeProperty(thisElement);
                    //adding the edition pencil
                    if (webuser.isWebAdmin()) {
                      const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
                      visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
                      title.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
                    }
                  </script>
                </span>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <div style="position:relative;">
        <div data-id="butedit" class="btmiddleright"></div>
        <input type="hidden" name="impalertmsg" disabled>
        <script>
          const myNode=thisNode.getNextChild("imploadingmsg").getRelationship("domelementsdata").getChild();
          myNode.writeProperty(thisElement);
          if (webuser.isWebAdmin()) {
            myNode.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement, thisAttribute: "value"});
            const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
            visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
            thisElement.type="text";
          }
        </script>
      </div>
      <div style="position:relative;">
        <div data-id="butedit" class="btmiddleright"></div>
        <input type="hidden" name="nocontent" disabled>
        <script>
          const myNode=thisNode.getNextChild("impnocontent").getRelationship("domelementsdata").getChild();
          myNode.writeProperty(thisElement);
          if (webuser.isWebAdmin()) {
            myNode.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement, thisAttribute: "value"});
            thisElement.type="text";
            const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
            visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
          }
        </script>
      </div>
      <div style="position:relative;">
        <div data-id="butedit" class="btmiddleright"></div>
        <input type="hidden" name="implangerror" disabled>
        <script>
          const myNode=thisNode.getNextChild("implangerror").getRelationship("domelementsdata").getChild();
          myNode.writeProperty(thisElement, null, "value");
          if (webuser.isWebAdmin()) {
            myNode.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement, thisAttribute: "value"});
            thisElement.type="text";
            const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
            visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
          }
        </script>
      </div>
      <span style="position:relative;">
        <div data-id="butedit" class="btmiddleright"></div>
        <button type="button" data-id="but" class="btn"></button>
        <script>
        thisNode.getNextChild("butimp").getRelationship("domelementsdata").getChild().writeProperty(thisElement);
        
        if (!webuser.isSystemAdmin) thisElement.disabled=true; //Only sysadmin for when we enter with webadmin to edit label texts
        
        const {languages} = await import('./' + CLIENT_MODULES_PATH + 'languages.js');
        const {AlertMessage}=await import('./' + CLIENT_MODULES_PATH + 'alert.js');
        const {Node, NodeMale, NodeFemale}=await import('./' + CLIENT_MODULES_PATH + 'nodesfront.js');
        
        thisElement.onclick=async function(){
          if (!thisElement.form.impdata.value) {
            (new AlertMessage(thisElement.form.elements.nocontent.value, 2000)).showAlert();
            return false;
          }
          if (!thisElement.form.dataoption.value){
            //we show the alert message No selection
            (new AlertMessage(thisElement.form.previousElementSibling.elements.noselection.value, 2000)).showAlert();
            return false;
          }
          const myimpalert=new AlertMessage(thisElement.form.elements.impalertmsg.value);
          if (thisElement.form.dataoption.value=="users") {
            myimpalert.showAlert();
             //First we add the remove tree request
            const usertypemother=await (new NodeFemale("TABLE_USERSTYPES", "TABLE_USERSTYPES")).loadRequest("get all my children", {filterProps: {type: "customer"}});
            const usertype=await usertypemother.getChild().loadRequest("get my tree");
            await usertype.getRelationship("users").request("delete my children");
            const newusersmother=(new NodeFemale()).load(JSON.parse(thisElement.form.impdata.value));
            newusersmother.partnerNode.props.id=usertypemother.getChild().props.id;
            const insertedIds=await newusersmother.request("add my children");
            myimpalert.hideAlert();
          }
          else if (thisElement.form.dataoption.value=="lang") {
            //Source is two elements: array of languages and array of domelments trees for each language
            //It imports new langs and add it
            const data=JSON.parse(thisElement.form.impdata.value);
            const datalang=[];
            for (const lang of data.languages) {
              datalang.push((new NodeMale()).load(lang));
            }
            
            if (datalang.length==0) {
              //we show the alert message No selection
              (new AlertMessage(thisElement.form.elements.nocontent.value, 2000)).showAlert();
              return;
            }

            //get selected data (checkbox selection)
            const myLangs=thisElement.form.querySelectorAll('input[type="checkbox"]');
            const selectedLangs=[];
            for (const myLang of myLangs) {
              if (myLang.checked) selectedLangs.push(Number(myLang.value));
            }
            if (selectedLangs.length==0) {
              //we show the alert message No selection
              (new AlertMessage(thisElement.form.previousElementSibling.elements.nocontent.value, 2000)).showAlert();
              return;
            }
            myimpalert.showAlert(); //importing in process
            //Now we filter the languages selected from the datalang
            const datatrees=[];
            for (const i in data.trees) {
              datatrees[i]= (new NodeMale()).load(data.trees[i]);
            }
            const filterdatatrees=[];
            const filterlangs=[];
            for (const selLang of selectedLangs) {
              for (const i in datalang) {
                if (selLang==datalang[i].props.id) {
                  //position is j
                  //we need to add the mother
                  datatrees[i].parentNode=new NodeFemale();
                  datatrees[i].parentNode.addChild(datatrees[i]);
                  filterdatatrees.push(datatrees[i]);
                  filterlangs.push(datalang[i]);
                  break;
                }
              }
            }
            //Now we need to replace the custom data with the lang data of the current site
            //This function do ???
            const replaceMyTreeLangData=(originalLangNode, candidatesMother)=>{
              const equivNode=candidatesMother.getChild(originalLangNode.props.name);
              if (equivNode) {
                originalLangNode.getRelationship("domelementsdata").getChild().props.value=equivNode.getRelationship("domelementsdata").getChild().props.value;
                for (const child of originalLangNode.getRelationship("domelements").children) {
                  replaceMyTreeLangData(child, equivNode.getRelationship("domelements"));
                }
              }
            };
            //Replace lang data at current site content node
            const langsToInsert=[];
            //We load current domelements textNode data for main language
            const myTextNode=thisNode.getrootnode().getNextChild("texts").cloneNode();
            await myTextNode.loadRequest("get my tree", {extraParents: languages.getChild().getRelationship("domelementsdata")}); //Labels is loaded at start but texts not
            for (const i in filterdatatrees) {
              const myLabelNode=thisNode.getrootnode().getNextChild("labels").cloneNode();
              //We replace the label lang content with the loaded lang content
              replaceMyTreeLangData(myLabelNode, filterdatatrees[i].parentNode);
              let rootNode=thisNode.getrootnode().cloneNode(1,1);
              rootNode.getRelationship("domelementsdata").addChild(thisNode.getrootnode().getRelationship("domelementsdata").getChild().cloneNode()); //restoring
              rootNode.getRelationship("domelements").addChild(myLabelNode);
              //We add the label text contents (menus pages)
              rootNode.getRelationship("domelements").addChild(myTextNode);
              langsToInsert.push({"lang":filterlangs[i], "domdata": rootNode});
            }
            //It transform the tree in an array
            function createdomnodesarray(myroot) {
              let treearray=myroot.arrayFromTree();
              let domdataarray=[];
              for (const mytree of treearray) {
                if (mytree.constructor.detecteGender(mytree)=="NodeMale") {
                  if (mytree.parentNode.props.name=="domelementsdata") {
                    domdataarray.push(mytree);
                  }
                }
              }
              return domdataarray;
            }
            //It adds the new lang and gets the id
            //Then it loads the site lang data nodes except the domelementsdata
            //Once we got all de lang data nodes we inert it raplacing lang parent with new lang parent one
            const languageAddCloneFirstLang=async (newLangNode, domdatachildren) => {
              //we add a new lang
              const newLangId=await newLangNode.request("add myself");

              //We copy the lang tree
              const newLang=await languages.getChild().cloneNode().loadRequest("get my tree");
              newLang.props.id=newLangId;
              console.log(newLang);
              const loadRequest=[];
              //var datavalue=[];
              for (const rel of newLang.relationships) {
                if (rel.props.name!="domelementsdata") {
                  for (const child of rel.children) {
                    loadRequest.push(child);
                    //datavalue.push(newLang.relationships[i].children[j].props);
                  }
                }
              }
              //we load the parent that belongs to data tree
              //And create the add myself list
              const myNodes=await Node.requestMulty("get my tree up", loadRequest, {deepLevel: 2}); //loads parent data that belongs to tree structure to give structure to de lang data
              const insertRequest=[];
              const parameters=[];
              for (const i in myNodes) {
                insertRequest[i]=new NodeMale();
                insertRequest[i].parentNode=myNodes[i];
                for (const pNode of myNodes[i]) {
                  if (pNode.props.parenttablename!="TABLE_LANGUAGES") {
                    insertRequest[i].parentNode=(new NodeFemale()).load(pNode);
                    parameters[i]={extraParents: newLang.getRelationship(insertRequest[i].parentNode.props.name)};
                    break;
                  }
                }
                insertRequest[i].props=loadRequest[i].props;
              }
              //Now we add the domelementsdata
              for (const domdatachild of domdatachildren) {
                insertRequest.push(domdatachild);
                parameters.push({extraParents: newLang.getRelationship(domdatachild.parentNode.props.name)});
              }
              return Node.requestMulty("add myself", insertRequest, parameters);
            };
            //Now we have to create the new languageAddCloneFirstLang(newLangNode, domdatachildren, listener)langs
            const iterationAddLangs=[];
            for (const langToInsert of langsToInsert) {
              //Now we have to make the tree to a serial data
              let domdataInsert=createdomnodesarray(langToInsert.domdata);
              myimpalert.showAlert();
              //document.getElementById("butimp").disabled=true;
              iterationAddLangs.push(languageAddCloneFirstLang(langToInsert.lang, domdataInsert));
            }
            Promise.all(iterationAddLangs)
            .then(()=>{
              myimpalert.hideAlert();
              document.location.reload();
            });
          }
          else if (thisElement.form.dataoption.value=="general" || thisElement.form.dataoption.value=="catalog" || thisElement.form.dataoption.value=="checkout") {
            myimpalert.showAlert();
            const data=JSON.parse(thisElement.form.impdata.value); // data: {languages, tree: [titles & subtitle data, menus data]}
            //insert the tree for one lang
            if (thisElement.form.dataoption.value=="general") {
              await impData(data.languages, "domelementsdata", thisNode.getrootnode().getNextChild("labels").getNextChild("top"),  (new NodeMale()).load(data.tree[0]));
              await impData(data.languages, "domelementsdata", thisNode.getrootnode().getNextChild("texts"),  (new NodeMale()).load(data.tree[1]));
              myimpalert.hideAlert();
              //document.location.reload();
            }
            else if  (thisElement.form.dataoption.value=="catalog") {
              const categoriesrootmother=await (new NodeFemale("TABLE_ITEMCATEGORIES", "TABLE_ITEMCATEGORIES")).loadRequest("get my root");
              const result=await impData(data.languages, "itemcategoriesdata", categoriesrootmother.getChild(), (new NodeMale()).load(data.tree));
              if (result) {
                myimpalert.hideAlert();
                webuser.dispatchEvent("log"); //This refresh the views. Better maybe refresh just categories
              }
            }
            else if (thisElement.form.dataoption.value=="checkout") {
              const shippingsrootmother=await (new NodeFemale("TABLE_SHIPPINGTYPES", "TABLE_SHIPPINGTYPES")).loadRequest("get my root");
              const paymentsrootmother=await (new NodeFemale("TABLE_PAYMENTTYPES", "TABLE_PAYMENTTYPES")).loadRequest("get my root");
              await impData(data.languages, "shippingtypesdata",shippingsrootmother.getChild(), (new NodeMale()).load(data.tree[0]));
              await impData(data.languages, "paymenttypesdata", paymentsrootmother.getChild(), (new NodeMale()).load(data.tree[1]));
              myimpalert.hideAlert();
              //document.location.reload();
            }
            
            async function impData(datalang, langrelname, rootelement, datatree) {
              const requestResultData=[]; //Complet final request container
              const requestResultActions=[];
              const requestResultParams=[];
              //Lets check that the languages meet the site languages
              let languagesmatch=false;
              if (datalang.length==languages.children.length) {
                languagesmatch=true;
                for (const i in datalang) {
                  if (datalang[i].props.id!=languages.children[i].props.id) {
                    languagesmatch=false;
                    break;
                  }
                }
              }
              if (!languagesmatch) {
                (new AlertMessage(thisElement.form.elements.implangerror.value, 2000)).showAlert();
                return false;
              }
              //We split the languages in one array of langdata for each language
              const treearray=datatree.arrayFromTree();
              const langnodes=[];
              let langarray;
              for (const i in datalang) {
                langnodes[i]=new NodeMale();
                langnodes[i].load(datatree);
                langarray=langnodes[i].arrayFromTree();
                for (const j in treearray) {
                  if (Node.detectGender(treearray[j])=="female" && treearray[j].props.language) {
                    //The children are the lang conent
                    langarray[j].children=[treearray[j].children[i]];
                  }
                }
              }
              
              if (!langarray || langarray.length==0) return false;
              //then we insert the tree with just first lang content and for the others
              //First we add the remove tree request
              requestResultData.push(rootelement);
              requestResultActions.push("delete my tree");
              requestResultParams.push(null);
              requestResultData.push(langnodes[0]);
              requestResultActions.push("add my tree");
              requestResultParams.push({extraParents: languages.children[0].getRelationship(langrelname)});
              console.log(requestResultActions, requestResultData, requestResultParams);
              const myResult=await Node.requestMulty(requestResultActions, requestResultData, requestResultParams);
              if (datalang.length<2) {
                return myResult;
              }
              
              const myNode=new NodeMale();
              myNode.load(myResult[1]);
              //The resulting tree then we will swap the lang content for each language, then insert again but just the lang content
              //We get to the list of nodes
              const newtreearray=myNode.arrayFromTree();
              //console.log(newtreearray, treearray);
              //For each language we swap content
              //Now we add the new language content but now just lang content
              var requestData=[];
              var requestParams=[];
              for (let i=1; i<datalang.length; i++) {
                for (const j in newtreearray) {
                  let langarray=langnodes[i].arrayFromTree();
                  if (Node.detectGender(newtreearray[j])=="female" && newtreearray[j].props.language) {
                    //console.log(newtreearray[j], langarray[j]);
                    //Swap the other langs content
                    newtreearray[j].children[0].props=langarray[j].children[0].props;
                  }
                }
                requestData.push(myNode);
                requestParams.push({extraParents: languages.children[i].getRelationship(langrelname), tableName: "TABLE_LANGUAGES"});
              }
              return await Node.requestMulty("add my tree table content", requestData, requestParams);
            }
          }
          else {
            //we show the alert message No selection
            (new AlertMessage(thisElement.form.perviousElementSibling.elements.noselection.value, 2000)).showAlert();
          }
          return false;
        };
        </script>
        <input type="hidden" disabled>
        <script>
          const myNode=thisNode.getNextChild("butimp").getRelationship("domelementsdata").getChild();
          myNode.writeProperty(thisElement);
          thisElement.onblur=function(){
            thisElement.type="hidden";
            thisElement.parentElement.querySelector('button[data-id=but]').innerHTML=thisElement.value;
          }
          //adding the edition pencil
          if (webuser.isWebAdmin()) {
            const {visibleOnMouseOver}=await import('./' + CLIENT_MODULES_PATH + 'frontutils.js');
            visibleOnMouseOver({element: thisElement.parentElement.querySelector('[data-id=butedit]'), parent: thisElement.parentElement});
            myNode.appendView(thisElement.parentElement.querySelector('[data-id=butedit]'), "butedit", {editElement: thisElement});
          }
        </script>
      </span>
    </form>
  </div>
</div>